<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Minha História de Vida - Um Jogo de Filosofia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background 1.5s ease-in-out;
        }
        
        /* FUNDOS COM GRADIENTES */
        .bg-start { background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); }
        .bg-infancia { background: linear-gradient(to top, #a1c4fd 0%, #c2e9fb 100%); }
        .bg-juventude { background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%); }
        .bg-crescimento { background: linear-gradient(to right, #f83600 0%, #f9d423 100%); }
        .bg-sabedoria { background: linear-gradient(to top, #09203f 0%, #537895 100%); }

        .progress-bar-inner { transition: width 0.5s ease-in-out; }
        .choice-button { transition: background-color 0.2s, transform 0.2s; }
        .choice-button:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0, 255, 255, 0.2); }
        .card, .start-card, .final-card, .gallery-card {
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            background-color: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.7s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .feedback-indicator { position: absolute; top: -20px; right: 10px; font-weight: bold; font-size: 1.1rem; animation: floatUp 1.5s ease-out forwards; }
        @keyframes floatUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-40px); } }
        .value-button.selected { border-color: #22d3ee; background-color: rgba(34, 211, 238, 0.1); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4 bg-start">

    <div id="startScreen" class="w-full max-w-2xl mx-auto text-center">
        <div class="start-card p-8 rounded-xl shadow-2xl">
            <h1 class="text-4xl font-bold text-cyan-300 mb-4">A Minha História de Vida</h1>
            <p class="text-lg mb-4 text-gray-300">Qual é o teu nome, aventureiro(a)?</p>
            <input type="text" id="playerNameInput" placeholder="Escreve o teu nome aqui" class="w-full bg-gray-700 text-white placeholder-gray-400 p-3 rounded-lg mb-6 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400">
            <p class="text-lg mb-4 text-gray-300">Agora, escolhe duas qualidades especiais.</p>
            <div id="valuesContainer" class="grid grid-cols-2 gap-4 mb-6"></div>
            <button id="startGameBtn" disabled class="bg-gray-600 text-white font-bold py-3 px-8 rounded-lg text-lg choice-button cursor-not-allowed w-full mb-4">Começar a Minha História</button>
            <button id="galleryBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg text-md choice-button w-full">Ver Galeria de Histórias</button>
        </div>
    </div>

    <div id="gameContainer" class="hidden w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 id="playerNameTitle" class="text-4xl font-bold text-cyan-300"></h1>
            <p id="stageTitle" class="text-2xl font-semibold mt-2 text-white transition-colors duration-500"></p>
            <p id="mindState" class="text-lg italic text-gray-300 mt-2 transition-opacity duration-500"></p>
        </header>
        <div id="resources" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 relative">
                <h3 class="font-semibold text-lg text-purple-300">Sabedoria</h3>
                <div class="w-full bg-gray-700 rounded-full h-4 mt-2"><div id="sabedoria-bar" class="bg-purple-500 h-4 rounded-full progress-bar-inner"></div></div>
            </div>
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 relative">
                <h3 class="font-semibold text-lg text-green-300">Imaginação</h3>
                <div class="w-full bg-gray-700 rounded-full h-4 mt-2"><div id="imaginacao-bar" class="bg-green-500 h-4 rounded-full progress-bar-inner"></div></div>
            </div>
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 relative">
                <h3 class="font-semibold text-lg text-yellow-300">Amizade</h3>
                <div class="w-full bg-gray-700 rounded-full h-4 mt-2"><div id="amizade-bar" class="bg-yellow-500 h-4 rounded-full progress-bar-inner"></div></div>
            </div>
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 relative">
                <h3 class="font-semibold text-lg text-rose-300">Alegria</h3>
                <div class="w-full bg-gray-700 rounded-full h-4 mt-2"><div id="alegria-bar" class="bg-rose-500 h-4 rounded-full progress-bar-inner"></div></div>
            </div>
        </div>
        <div id="eventCardContainer"></div>
        <div class="mt-8">
             <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-300">Diário de Bordo</h2>
             <div id="diarioContent" class="w-full h-48 bg-gray-800 border border-gray-700 rounded-lg p-4 overflow-y-auto text-gray-300 font-mono text-sm"></div>
        </div>
    </div>
    
    <div id="finalScreen" class="hidden w-full max-w-4xl mx-auto text-center">
        <div class="final-card p-8 rounded-xl shadow-2xl">
            <h1 class="text-5xl font-bold text-cyan-300 mb-4">A Tua História de Vida</h1>
            <div class="md:flex md:items-center md:space-x-8 mb-8">
                 <div class="md:w-1/3 text-center">
                     <img id="monsterImage" src="" alt="O teu monstrinho de alma" class="mx-auto rounded-lg mb-4 shadow-lg w-48 h-48">
                     <h3 id="monsterName" class="text-2xl font-bold text-yellow-300"></h3>
                     <p id="monsterDescription" class="text-sm text-gray-400 mt-1"></p>
                 </div>
                 <div id="archetypeResult" class="md:w-2/3 mt-6 md:mt-0">
                    <h2 class="text-3xl font-semibold text-yellow-300"></h2>
                    <p class="text-lg mt-2 text-gray-300"></p>
                 </div>
            </div>
            <h2 class="text-3xl font-semibold text-white mb-4">As Tuas Qualidades Finais</h2>
            <div id="finalResourcesGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-left"></div>
            <h2 class="text-3xl font-semibold text-white mb-4">A Tua Narrativa</h2>
            <div id="finalDiario" class="w-full h-40 bg-gray-800 border border-gray-700 rounded-lg p-6 overflow-y-auto text-gray-300 font-mono text-left mb-8"></div>
            <p class="mb-8 italic text-gray-400">"A vida é uma grande aventura ou não é nada." - Helen Keller</p>
            <button onclick="restartGame()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg text-lg choice-button shadow-lg w-full">
                Viver Outra Aventura
            </button>
        </div>
    </div>

    <div id="galleryScreen" class="hidden w-full max-w-3xl mx-auto text-center">
        <div class="gallery-card p-8 rounded-xl shadow-2xl">
            <h1 class="text-4xl font-bold text-cyan-300 mb-6">Galeria de Histórias</h1>
            <div id="galleryContent" class="max-h-[60vh] overflow-y-auto pr-4 text-left space-y-4 mb-6">
                </div>
            <button onclick="closeGallery()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg text-lg choice-button w-full">Voltar ao Início</button>
        </div>
    </div>

    <script>
    // --- DADOS DO JOGO (EDIÇÃO MONSTRUOSA) ---
    const coreValues = {
        honestidade: { name: "Honestidade", effects: { sabedoria: 10, alegria: -5 }, description: "+10 Sabedoria, -5 Alegria" },
        criatividade: { name: "Criatividade", effects: { imaginacao: 10, amizade: -5 }, description: "+10 Imaginação, -5 Amizade" },
        amizade: { name: "Amizade", effects: { amizade: 10, sabedoria: -5 }, description: "+10 Amizade, -5 Sabedoria" },
        coragem: { name: "Coragem", effects: { alegria: 10, imaginacao: -5 }, description: "+10 Alegria, -5 Imaginação" }
    };
    
    const surpriseEvents = [
        { text: "Que sorte! Encontraste um trevo de quatro folhas que pisca o olho!", effects: { alegria: 15 }, reflection: "Um pouco de sorte tornou o meu dia mais feliz." },
        { text: "Uau! Tiveste uma ideia tão brilhante que uma lâmpada apareceu por cima da tua cabeça!", effects: { imaginacao: 15 }, reflection: "A minha imaginação levou-me a lugares incríveis." },
        { text: "Fantástico! Ajudaste um amigo a apanhar o chapéu que voou, e ele deu-te um chocolate gigante.", effects: { amizade: 15 }, reflection: "Ajudar um amigo fez-me sentir muito bem." },
        { text: "Incrível! Resolveste um enigma que fez o professor de matemática coçar a cabeça.", effects: { sabedoria: 15 }, reflection: "Descobri que sou mais esperto do que pensava." },
        { text: "Num dia de chuva, saltaste numa poça de água e fizeste um arco-íris!", effects: { alegria: 10, imaginacao: 5 }, reflection: "Vi beleza onde menos esperava." }
    ];

    const originalGameData = {
        stages: [
            { stage: "Infância", color: "text-blue-300", bgClass: "bg-infancia", events: [
                { type: 'choice', text: "No recreio, um colega diz que consegue voar se saltar do baloiço. O que fazes, {playerName}?", choices: [ { text: "Digo-lhe 'Boa sorte!' e fico a ver o que acontece.", effects: { alegria: 10, sabedoria: -10 }, reflection: "Às vezes, a curiosidade fala mais alto que a razão." }, { text: "Convenço-o a não saltar, talvez com uma almofada no chão.", effects: { sabedoria: 10, amizade: 10, alegria: -5 }, reflection: "Aprendi que cuidar dos amigos é a coisa certa a fazer." } ] },
                { type: 'choice', text: "Os teus pais mandam-te arrumar o quarto, que parece um campo de batalha de brinquedos. O que fazes?", choices: [ { text: "Arrumo tudo, mas transformo a arrumação numa missão de espionagem.", effects: { imaginacao: 10, sabedoria: 5 }, reflection: "A minha imaginação tornou as tarefas chatas em aventuras." }, { text: "Escondo tudo debaixo da cama. O que não se vê, não existe!", effects: { alegria: 5, sabedoria: -10 }, reflection: "Aprendi a encontrar atalhos, mesmo que não fossem os melhores." } ] },
                { type: 'choice', text: "Na hora do lanche, tens uma sanduíche de queijo, mas o teu amigo tem uma de Nutella. O que fazes?", choices: [ { text: "Proponho trocar metade da minha pela metade da dele.", effects: { amizade: 15, alegria: 5 }, reflection: "Partilhar com os amigos torna tudo mais saboroso." }, { text: "Olho para a sanduíche dele com ar de cãozinho abandonado até ele me dar um bocado.", effects: { imaginacao: 5, amizade: -5 }, reflection: "Tentei usar o meu charme para conseguir o que queria." } ] },
                { type: 'choice', text: "A professora pergunta quem comeu o último biscoito da caixa. Foste tu. O que dizes?", choices: [ { text: "Digo a verdade. Um biscoito não vale uma mentira.", effects: { sabedoria: 10, alegria: -5 }, reflection: "Gosto de ser honesto, mesmo que me meta em sarilhos." }, { text: "Digo que foi um fantasma comilão.", effects: { imaginacao: 10, sabedoria: -10 }, reflection: "Inventei uma boa desculpa para escapar." } ] },
                { type: 'choice', text: "Encontras um caracol super lento a atravessar o passeio. O que fazes?", choices: [ { text: "Faço uma corrida contra ele para ver quem é mais rápido (e deixo-o ganhar).", effects: { alegria: 10, amizade: 5 }, reflection: "Aprendi a divertir-me com as coisas mais simples." }, { text: "Pego nele e levo-o para a relva, para não ser pisado.", effects: { sabedoria: 10 }, reflection: "Senti que era importante proteger os mais pequenos." } ] },
            ]},
            { stage: "Juventude", color: "text-indigo-300", bgClass: "bg-juventude", events: [
                { id: 'consequence_low_joy', type: 'choice', text: "Como não te sentiste muito feliz na infância, agora sentes-te um pouco triste. O que fazes para te sentires melhor?", isConsequence: true, choices: [ { text: "Começo a desenhar e a inventar histórias.", effects: { amizade: 15, sabedoria: 10, alegria: 5 }, reflection: "Na tristeza, procurei uma luz na minha imaginação." }, { text: "Fico mais tempo sozinho no meu quarto.", effects: { sabedoria: -10, alegria: -10, imaginacao: -5 }, reflection: "O isolamento pareceu a única forma de lidar com a tristeza." } ] },
                { type: 'choice', text: "Tens de escolher uma alcunha para a equipa da escola. Qual sugeres?", choices: [ { text: "Os 'Dragões Destemidos'. Soa a poderoso!", effects: { imaginacao: 15, amizade: 5 }, reflection: "Gosto de nomes que mostram força e fantasia." }, { text: "A 'Equipa Amiga'. O que importa é estarmos juntos.", effects: { amizade: 15, imaginacao: -5 }, reflection: "Para mim, a união da equipa era o mais importante." } ] },
                { type: 'choice', text: "Um amigo conta-te uma anedota seca, sem piada nenhuma. Como reages?", choices: [ { text: "Dou uma gargalhada gigante para ele não ficar triste.", effects: { amizade: 15, alegria: 5, sabedoria: -5 }, reflection: "Às vezes, uma pequena mentira faz um amigo feliz." }, { text: "Fico sério e digo 'Não percebi a piada'.", effects: { sabedoria: 10, amizade: -10 }, reflection: "Prefiro ser honesto, mesmo que magoe um bocadinho." } ] },
                { type: 'choice', text: "Os teus pais dão-te uma tarefa: regar uma planta. O que acontece à planta?", choices: [ { text: "Transforma-se na planta mais bonita do bairro, com o meu cuidado.", effects: { sabedoria: 15, alegria: 5 }, reflection: "Aprendi que a responsabilidade dá frutos (ou flores)." }, { text: "Esqueço-me de a regar... Ups. Agora parece uma alface murcha.", effects: { alegria: -10, sabedoria: -15 }, reflection: "Descobri que as plantas não sobrevivem só com boas intenções." } ] },
                { type: 'choice', text: "A tua banda preferida vai dar um concerto, mas é na mesma noite da festa de pijama do teu melhor amigo. O que fazes?", choices: [ { text: "Vou ao concerto. O meu amigo vai perceber.", effects: { alegria: 15, amizade: -15 }, reflection: "Segui a minha paixão, mesmo que isso significasse desapontar um amigo." }, { text: "Vou à festa de pijama. Os amigos vêm primeiro.", effects: { amizade: 15, alegria: -10 }, reflection: "A lealdade aos meus amigos era mais importante que a diversão." } ] },
            ]},
            { stage: "Crescimento", color: "text-orange-300", bgClass: "bg-crescimento", events: [
                { id: 'consequence_low_imagination', type: 'choice', text: "Sentes que a tua imaginação está um pouco presa. Surge uma oportunidade de entrar num clube de teatro. Vais?", isConsequence: true, choices: [ { text: "Sim! Preciso de uma nova aventura.", effects: { imaginacao: 30, alegria: 15, amizade: -10 }, reflection: "Num momento de viragem, escolhi a imaginação." }, { text: "Não, tenho vergonha. Prefiro continuar como estou.", effects: { sabedoria: 10, alegria: 5, imaginacao: -10 }, reflection: "Preferi ficar na minha zona de conforto." } ] },
                { id: 'consequence_high_imagination', type: 'choice', text: "Sempre tiveste uma imaginação gigante, mas às vezes sentes-te sozinho nos teus mundos. Um amigo convida-te para formar uma equipa. Aceitas?", isConsequence: true, choices: [ { text: "Sim. Percebo que partilhar a imaginação é mais divertido.", effects: { alegria: 20, amizade: 15, imaginacao: -15 }, reflection: "Percebi que a imaginação cresce quando a partilhamos." }, { text: "Não. Gosto mais de estar no meu próprio mundo.", effects: { sabedoria: 10, imaginacao: 10, alegria: -10 }, reflection: "Mantive-me fiel ao meu mundo, aceitando a solidão como seu preço." } ] },
                { type: 'choice', text: "Montas um puzzle de 1000 peças, mas falta a última peça. O que fazes?", choices: [ { text: "Desenho a peça que falta num bocado de cartão. Fica perfeito!", effects: { imaginacao: 20, alegria: 5 }, reflection: "Quando a vida não me dá o que preciso, eu invento!" }, { text: "Fico frustrado e desarrumo o puzzle todo.", effects: { alegria: -15, imaginacao: -10 }, reflection: "Aprendi que a frustração pode deitar tudo a perder." }, { text: "Procuro a peça por toda a casa, debaixo dos sofás e das camas.", effects: { sabedoria: 15 }, reflection: "A persistência é a chave para resolver problemas." } ] },
                { type: 'choice', text: "O teu amigo pintou o cabelo de verde. Toda a gente se está a rir. O que dizes?", choices: [ { text: "Digo 'Está espetacular! Pareces um super-herói!'", effects: { amizade: 15, imaginacao: 5 }, reflection: "Apoiei a coragem do meu amigo, mesmo que fosse diferente." }, { text: "Rio-me também. Está mesmo muito esquisito.", effects: { alegria: 5, amizade: -15 }, reflection: "Fui com a multidão, mesmo que isso magoasse o meu amigo." } ] },
                { type: 'choice', text: "Encontras uma carteira cheia de cromos de futebol raros. O que fazes?", choices: [ { text: "Procuro o dono. Sei o quanto custa ter uma coleção.", effects: { sabedoria: 20, amizade: 5 }, reflection: "Fazer o que está certo é o mais importante." }, { text: "Fico com os cromos para a minha coleção!", effects: { alegria: 10, sabedoria: -20 }, reflection: "A tentação de ter algo novo foi mais forte." } ] },
                { type: 'choice', text: "Tens a oportunidade de criar um projeto para a escola. O que escolhes?", choices: [ { text: "Um vulcão que deita mesmo lava (de vinagre e bicarbonato).", effects: { imaginacao: 15, sabedoria: 5 }, reflection: "Adoro projetos que fazem uma grande confusão criativa." }, { text: "Um relatório muito bem escrito sobre os planetas.", effects: { sabedoria: 15, imaginacao: -5 }, reflection: "Prefiro a organização e o conhecimento à confusão." } ] }
            ]},
            { stage: "Sabedoria", color: "text-teal-300", bgClass: "bg-sabedoria", events: [
                { id: 'consequence_high_friendship', type: 'choice', text: "Fizeste muitos amigos e todos gostam de ti. Convidam-te para seres o capitão da equipa, mas isso significa ter menos tempo para ti. Aceitas?", isConsequence: true, choices: [ { text: "Sim! Adoro ajudar a minha equipa.", effects: { sabedoria: 20, amizade: 10, alegria: -10 }, reflection: "A minha escolha final foi pela amizade e pela equipa." }, { text: "Não, preciso de mais tempo para as minhas coisas.", effects: { alegria: 15, amizade: -15, imaginacao: -5 }, reflection: "Aprendi que também preciso de tempo para mim." } ] },
                { id: 'consequence_low_friendship', type: 'choice', text: "Sentes que não tens muitos amigos. O que fazes?", isConsequence: true, choices: [ { text: "Tento conhecer pessoas novas. Nunca é tarde.", effects: { amizade: 25, imaginacao: 10, alegria: 5 }, reflection: "Na vida, descobri que podemos sempre fazer novos amigos." }, { text: "Aceito e encontro a felicidade nas coisas que gosto de fazer sozinho.", effects: { alegria: 15, sabedoria: 5 }, reflection: "Abdiquei da busca por muitos amigos e encontrei alegria em mim mesmo." } ] },
                { type: 'choice', text: "Se pudesses ter um super-poder, qual seria?", choices: [ { text: "Ler a mente das pessoas para as perceber melhor.", effects: { sabedoria: 20, amizade: 10 }, reflection: "O meu maior desejo era perceber os outros." }, { text: "Voar para explorar o mundo e ter grandes aventuras.", effects: { imaginacao: 20, alegria: 10 }, reflection: "A minha alma sempre foi de um aventureiro." } ] },
                { type: 'choice', text: "Um amigo mais novo pede-te um conselho sobre como ser fixe. O que lhe dizes, {playerName}?", choices: [ { text: "Digo-lhe para ser ele mesmo. As pessoas mais fixes são as que são verdadeiras.", effects: { sabedoria: 20, amizade: 5 }, reflection: "A minha maior lição foi sobre a importância de sermos nós próprios." }, { text: "Digo-lhe para aprender a contar anedotas de papagaios.", effects: { imaginacao: 10, alegria: 10 }, reflection: "A minha maior lição foi que o humor nos torna a todos mais fixes." } ] },
                { type: 'choice', text: "Vês um colega novo na turma que está sozinho e parece triste. O que fazes?", choices: [ { text: "Vou ter com ele e pergunto se quer jogar às cartas invisíveis comigo.", effects: { amizade: 20, imaginacao: 5 }, reflection: "Acredito que um pouco de imaginação pode curar a solidão." }, { text: "Deixo-o estar. Ele deve querer estar sozinho.", effects: { amizade: -10 }, reflection: "Às vezes, não sei bem como chegar perto dos outros." } ] },
                 { type: 'choice', text: "Qual é a coisa mais importante para uma vida feliz?", choices: [ { text: "Ter sempre um bom livro para ler e uma boa piada para contar.", effects: { sabedoria: 15, alegria: 10 }, reflection: "Escolhi o caminho do conhecimento e do riso." }, { text: "Ter sempre amigos para partilhar gelados e aventuras.", effects: { amizade: 15, alegria: 10 }, reflection: "Escolhi o caminho do coração e da partilha." } ] }
            ]}
        ]
    };

    let gameState = {};
    let selectedValues = [];
    const audio = {
        sfxSynth: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.4 } }).toDestination(),
        ambienceSynth: new Tone.Synth({ oscillator: { type: 'fatsine2' }, envelope: { attack: 0.1, decay: 0.1, sustain: 0.2, release: 0.8 } }).toDestination(),
        ambience: new Tone.Loop(time => { audio.ambienceSynth.triggerAttackRelease("C2", "2n", time); }, "2n").start(0),
        isStarted: false,
        start: function() { if (!this.isStarted) { Tone.start(); Tone.Transport.start(); this.isStarted = true; } },
        playChoice: () => audio.sfxSynth.triggerAttackRelease("C4", "8n"),
        playNewStage: () => audio.sfxSynth.triggerAttackRelease("G4", "4n"),
        playSurprise: () => audio.sfxSynth.triggerAttackRelease("E5", "8n")
    };

    function initializeGameState() {
        gameState = {
            playerName: "", currentStageIndex: 0, currentEventIndex: 0,
            resources: { sabedoria: 50, imaginacao: 50, amizade: 50, alegria: 50 },
            diario: "O início da minha aventura...\n",
            gameData: JSON.parse(JSON.stringify(originalGameData))
        };
    }
    
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function setupStartScreen() {
        const valuesContainer = document.getElementById('valuesContainer');
        valuesContainer.innerHTML = Object.entries(coreValues).map(([key, value]) => `
            <button data-value-key="${key}" class="p-4 border-2 border-gray-600 rounded-lg text-left hover:bg-gray-700 hover:border-cyan-400 transition-colors value-button">
                <h3 class="font-bold text-lg">${value.name}</h3>
                <p class="text-sm text-gray-400">${value.description}</p>
            </button>`).join('');
        document.querySelectorAll('.value-button').forEach(btn => btn.onclick = () => selectValue(btn.dataset.valueKey));
        document.getElementById('startGameBtn').onclick = startGame;
        document.getElementById('playerNameInput').addEventListener('input', checkStartButton);
    }

    function selectValue(valueKey) {
        audio.start();
        const button = document.querySelector(`[data-value-key="${valueKey}"]`);
        const index = selectedValues.indexOf(valueKey);
        if (index > -1) {
            selectedValues.splice(index, 1);
            button.classList.remove('selected');
        } else {
            if (selectedValues.length < 2) {
                selectedValues.push(valueKey);
                button.classList.add('selected');
            }
        }
        checkStartButton();
    }

    function checkStartButton() {
        const name = document.getElementById('playerNameInput').value;
        const btn = document.getElementById('startGameBtn');
        const canStart = selectedValues.length === 2 && name.trim() !== '';
        btn.disabled = !canStart;
        btn.classList.toggle('bg-gray-600', !canStart);
        btn.classList.toggle('cursor-not-allowed', !canStart);
        btn.classList.toggle('bg-cyan-500', canStart);
        btn.classList.toggle('hover:bg-cyan-600', canStart);
    }

    function startGame() {
        audio.playNewStage();
        initializeGameState();
        gameState.playerName = document.getElementById('playerNameInput').value;
        document.getElementById('playerNameTitle').textContent = `A História de ${gameState.playerName}`;
        
        selectedValues.forEach(key => {
            const value = coreValues[key];
            gameState.diario += `\nGuiado(a) pela ${value.name}...`;
            Object.entries(value.effects).forEach(([resource, effect]) => gameState.resources[resource] += effect);
        });

        gameState.gameData.stages.forEach(stage => {
            const consequenceEvents = stage.events.filter(event => event.isConsequence);
            let regularEvents = stage.events.filter(event => !event.isConsequence);
            shuffleArray(regularEvents);
            const selectedEvents = regularEvents.slice(0, 3);
            stage.events = [...consequenceEvents, ...selectedEvents];
        });

        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('galleryScreen').classList.add('hidden');
        document.getElementById('gameContainer').classList.remove('hidden');
        updateDiario();
        updateMindState();
        updateAtmosphere();
        displayCurrentEvent();
    }
    
    function displaySurpriseEvent(surprise) {
        audio.playSurprise();
        const eventCardContainer = document.getElementById('eventCardContainer');
        eventCardContainer.innerHTML = `
           <div class="card p-8 rounded-xl shadow-2xl border-2 border-yellow-400">
               <h3 class="text-2xl font-bold text-yellow-300 mb-4">Momento de Sorte!</h3>
               <p class="text-xl mb-6 min-h-[6rem]">${surprise.text}</p>
               <button onclick="handleSurprise('${btoa(JSON.stringify(surprise))}')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-3 px-4 rounded-lg choice-button">Fantástico!</button>
           </div>`;
    }
    
    function handleSurprise(base64Surprise) {
        const surprise = JSON.parse(atob(base64Surprise));
        Object.entries(surprise.effects).forEach(([resource, value]) => {
            gameState.resources[resource] = Math.max(0, Math.min(100, gameState.resources[resource] + value));
            showFeedbackIndicator(resource, value);
        });

        gameState.diario += `\n[Momento de Sorte] ${surprise.reflection}\n`;
        updateDiario();
        updateMindState();
        advanceGame();
        displayCurrentEvent();
    }


    function displayCurrentEvent() {
        if (gameState.currentStageIndex >= gameState.gameData.stages.length) {
            showFinalScreen();
            return;
        }

        checkForConsequences();
        const stage = gameState.gameData.stages[gameState.currentStageIndex];
        const event = stage.events[gameState.currentEventIndex];

        if (!event) { 
            advanceToNextStage();
            displayCurrentEvent();
            return;
        }

        if (event.isConsequence && !event.triggered) {
            advanceGame();
            displayCurrentEvent();
            return;
        }

        document.getElementById('stageTitle').textContent = stage.stage;
        document.getElementById('stageTitle').className = `text-2xl font-semibold mt-2 transition-colors duration-500 ${stage.color}`;

        const eventCardContainer = document.getElementById('eventCardContainer');
        eventCardContainer.innerHTML = `
           <div class="card p-8 rounded-xl shadow-2xl">
               <p class="text-xl mb-6 min-h-[6rem]">${event.text.replace(/{playerName}/g, gameState.playerName)}</p>
               <div class="flex flex-col space-y-4">
                   ${event.choices.map((choice, index) => `<button onclick="selectChoice(${index})" class="w-full bg-gray-700 hover:bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg choice-button">${choice.text}</button>`).join('')}
               </div>
           </div>`;
        
        updateResourceBars();
    }

    function selectChoice(choiceIndex) {
        audio.playChoice();
        const stage = gameState.gameData.stages[gameState.currentStageIndex];
        const event = stage.events[gameState.currentEventIndex];
        const choice = event.choices[choiceIndex];

        Object.entries(choice.effects).forEach(([resource, value]) => {
            gameState.resources[resource] = Math.max(0, Math.min(100, gameState.resources[resource] + value));
            showFeedbackIndicator(resource, value);
        });

        gameState.diario += `\n[${stage.stage}] ${choice.reflection}\n`;
        updateDiario();
        
        if (Math.random() < 0.25) { // 25% de chance de um momento de sorte
            const randomSurprise = surpriseEvents[Math.floor(Math.random() * surpriseEvents.length)];
            setTimeout(() => displaySurpriseEvent(randomSurprise), 500);
        } else {
            updateMindState();
            advanceGame();
            displayCurrentEvent();
        }
    }
    
    function advanceToNextStage() {
        const oldStageIndex = gameState.currentStageIndex;
        gameState.currentStageIndex++;
        gameState.currentEventIndex = 0;
        const newStageIndex = gameState.currentStageIndex;

        if (oldStageIndex !== newStageIndex && newStageIndex < gameState.gameData.stages.length) {
            updateAtmosphere();
            audio.playNewStage();
        }
    }

    function advanceGame() {
        const oldStageIndex = gameState.currentStageIndex;
        gameState.currentEventIndex++;
        const stage = gameState.gameData.stages[oldStageIndex];

        if (!stage || gameState.currentEventIndex >= stage.events.length) {
            advanceToNextStage();
        }
    }

    function checkForConsequences() {
        const r = gameState.resources;
        const stageIdx = gameState.currentStageIndex;
        if (gameState.currentEventIndex !== 0) return;

        if (stageIdx === 1 && r.alegria < 40) setConsequenceTrigger('consequence_low_joy');
        else if (stageIdx === 2) {
            if (r.imaginacao < 40) setConsequenceTrigger('consequence_low_imagination');
            else if (r.imaginacao > 75) setConsequenceTrigger('consequence_high_imagination');
        } else if (stageIdx === 3) {
            if (r.amizade > 75) setConsequenceTrigger('consequence_high_friendship');
            else if (r.amizade < 40) setConsequenceTrigger('consequence_low_friendship');
        }
    }

    function setConsequenceTrigger(eventId) {
        for (const stage of gameState.gameData.stages) {
            const event = stage.events.find(e => e.id === eventId);
            if (event) {
                event.triggered = true;
                return;
            }
        }
    }

    function updateAtmosphere() {
        if (gameState.currentStageIndex >= gameState.gameData.stages.length) return;
        const stage = gameState.gameData.stages[gameState.currentStageIndex];
        document.body.className = `bg-gray-900 text-white min-h-screen flex items-center justify-center p-4 ${stage.bgClass}`;
    }

    function updateMindState() {
        const r = gameState.resources;
        const sorted = Object.entries(r).sort((a, b) => b[1] - a[1]);
        const [h1_key] = sorted[0];
        
        let state = "A descobrir o caminho";
        if (h1_key === 'alegria') state = "Com um sorriso no rosto";
        else if (h1_key === 'amizade') state = "Rodeado de amigos";
        else if (h1_key === 'imaginacao') state = "A sonhar acordado";
        else if (h1_key === 'sabedoria') state = "A pensar em grandes ideias";
        
        document.getElementById('mindState').textContent = state;
    }

    function showFeedbackIndicator(resource, value) {
        const resourceContainer = document.getElementById(`${resource}-bar`).closest('.relative');
        const indicator = document.createElement('div');
        indicator.textContent = (value > 0 ? '+' : '') + value;
        indicator.className = `feedback-indicator ${value > 0 ? 'text-green-400' : 'text-red-400'}`;
        resourceContainer.appendChild(indicator);
        setTimeout(() => indicator.remove(), 1500);
    }

    function updateResourceBars() {
        for (const resource in gameState.resources) {
            document.getElementById(`${resource}-bar`).style.width = `${gameState.resources[resource]}%`;
        }
    }

    function updateDiario() {
        const diarioEl = document.getElementById('diarioContent');
        diarioEl.textContent = gameState.diario;
        diarioEl.scrollTop = diarioEl.scrollHeight;
    }

    function showFinalScreen() {
        audio.playNewStage();
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('finalScreen').classList.remove('hidden');
        document.getElementById('finalDiario').textContent = gameState.diario;
        
        const archetype = determineArchetype();
        document.getElementById('archetypeResult').querySelector('h2').textContent = archetype.title;
        document.getElementById('archetypeResult').querySelector('p').textContent = archetype.description;
        
        document.getElementById('monsterImage').src = archetype.monsterImage;
        document.getElementById('monsterName').textContent = archetype.monsterName;
        document.getElementById('monsterDescription').textContent = archetype.monsterDescription;

        document.getElementById('finalResourcesGrid').innerHTML = Object.entries(gameState.resources).map(([key, value]) => `<div class="p-4 rounded-lg bg-gray-800 border border-gray-700"><h3 class="font-semibold text-lg text-white">${key.charAt(0).toUpperCase() + key.slice(1)}</h3><p class="text-3xl font-bold mt-1">${value}%</p></div>`).join('');
        saveLife();
    }

    function determineArchetype() {
        const r = gameState.resources;
        const sorted = Object.entries(r).sort((a, b) => b[1] - a[1]);
        const [h1_key, h1_val] = sorted[0];
        const [h2_key, h2_val] = sorted[1];
        const [l1_key, l1_val] = sorted[3];

        if (h1_val > 75) {
            if (l1_val < 30) {
                if (h1_key === 'amizade' && l1_key === 'alegria') return { title: "O Herói dos Amigos", description: "Sacrificaste a própria alegria para ajudar os teus amigos, deixando um legado de lealdade.", monsterName: "Cãozão de Três Caudas", monsterDescription: "Um cão leal e trapalhão com caudas que abanam para todo o lado.", monsterImage: "images/monstro-cao.png" };
                if (h1_key === 'sabedoria' && l1_key === 'imaginacao') return { title: "O Pensador Silencioso", description: "Tornaste-te muito sábio, mas guardaste os teus pensamentos e sonhos para ti.", monsterName: "Tartaruga-biblioteca", monsterDescription: "Uma tartaruga com uma carapaça cheia de livros que lê muito devagarinho.", monsterImage: "images/monstro-tartaruga.png" };
                if (h1_key === 'alegria' && l1_key === 'amizade') return { title: "O Aventureiro Feliz", description: "Viveste uma vida cheia de alegria e diversão, preferindo aventuras a grandes grupos de amigos.", monsterName: "Macaco-foguete", monsterDescription: "Um macaco com um foguete nas costas, sempre pronto para a próxima confusão.", monsterImage: "images/monstro-macaco.png" };
            }
            if (h1_key === 'sabedoria') return { title: "O Grande Sábio", description: "A tua jornada foi para aprender e perceber o mundo. A tua sabedoria é a tua maior força.", monsterName: "Coruja de Óculos", monsterDescription: "Uma coruja muito séria com óculos gigantes que estão sempre tortos.", monsterImage: "images/monstro-coruja.png" };
            if (h1_key === 'imaginacao') return { title: "O Sonhador Criativo", description: "Nunca deixaste de sonhar e de inventar. Criaste mundos fantásticos na tua imaginação.", monsterName: "Nuvem Saltitante", monsterDescription: "Uma nuvem fofinha que muda de cor e, às vezes, chove purpurinas.", monsterImage: "images/monstro-nuvem.png" };
            if (h1_key === 'amizade') return { title: "O Construtor de Pontes", description: "A tua maior força foi unir as pessoas e criar amizades fortes e verdadeiras.", monsterName: "Lontra de Abraços", monsterDescription: "Uma lontra super amigável que quer dar um abraço a toda a gente.", monsterImage: "images/monstro-lontra.png" };
            if (h1_key === 'alegria') return { title: "O Colecionador de Sorrisos", description: "Procuraste a alegria em todos os momentos, e partilhaste sorrisos com todos à tua volta.", monsterName: "Risadinha-bola", monsterDescription: "Uma bola fofinha e saltitante que se ri às gargalhadas sempre que se move.", monsterImage: "images/monstro-risadinha.png" };
        }

        if (h1_val > 60 && h2_val > 60) {
            const keys = [h1_key, h2_key];
            if (keys.includes('sabedoria') && keys.includes('amizade')) return { title: "O Rei Sábio e Justo", description: "Usaste a tua sabedoria para ajudar os teus amigos e seres um líder justo.", monsterName: "Leão de Juba Penteada", monsterDescription: "Um leão majestoso que se preocupa muito em ter a sua juba sempre bem penteada.", monsterImage: "images/monstro-leao.png" };
            if (keys.includes('imaginacao') && keys.includes('alegria')) return { title: "O Explorador de Mundos", description: "A tua alegria e imaginação levaram-te a viver aventuras fantásticas e a descobrir coisas novas.", monsterName: "Toupeira com Periscópio", monsterDescription: "Uma toupeira que usa um chapéu de marinheiro e espia o mundo com um periscópio.", monsterImage: "images/monstro-toupeira.png" };
            if (keys.includes('amizade') && keys.includes('alegria')) return { title: "O Capitão da Equipa", description: "Foste um amigo incrível que trouxe alegria a toda a gente, um verdadeiro líder de equipa!", monsterName: "Formiga Megafone", monsterDescription: "Uma formiga pequenina que anda sempre com um megafone gigante a animar os amigos.", monsterImage: "images/monstro-formiga.png" };
        }
        
        if (l1_val < 35 && h1_val < 65) {
             return { title: "O Aprendiz da Vida", description: "A tua jornada foi calma e tranquila. Estás sempre pronto para aprender mais.", monsterName: "Camaleão-pijama", monsterDescription: "Um camaleão que está sempre de pijama e com ar de sono, mas muito curioso.", monsterImage: "images/monstro-camaleao.png" };
        }

        return { title: "O Mestre do Equilíbrio", description: "Conseguiste equilibrar todas as tuas qualidades, vivendo uma vida completa e harmoniosa.", monsterName: "Foca Equilibrista", monsterDescription: "Uma foca que consegue equilibrar uma torre de gelatinas no nariz sem as deixar cair.", monsterImage: "images/monstro-foca.png" };
    }
    
    function saveLife() {
        try {
            const lives = JSON.parse(localStorage.getItem('pastLives_v4_primary') || '[]');
            const archetype = determineArchetype();
            lives.unshift({
                name: gameState.playerName,
                archetype: archetype.title,
                resources: gameState.resources,
                date: new Date().toLocaleString('pt-PT')
            });
            if (lives.length > 10) lives.pop();
            localStorage.setItem('pastLives_v4_primary', JSON.stringify(lives));
        } catch (e) {
            console.error("Não foi possível guardar a história:", e);
        }
    }

    function openGallery() {
        audio.start();
        audio.playChoice();
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('galleryScreen').classList.remove('hidden');
        const galleryContent = document.getElementById('galleryContent');
        try {
            const lives = JSON.parse(localStorage.getItem('pastLives_v4_primary') || '[]');
            if (lives.length === 0) {
                galleryContent.innerHTML = '<p class="text-gray-400 text-center">Ainda não foram vividas histórias. A tua aventura está prestes a começar.</p>';
            } else {
                galleryContent.innerHTML = lives.map(life => `
                    <div class="border-l-4 border-cyan-500 pl-4 py-2 bg-gray-800/50 rounded">
                        <p class="font-bold text-xl text-white">${life.name} - "${life.archetype}"</p>
                        <p class="text-sm text-gray-400">${life.date}</p>
                    </div>
                `).join('');
            }
        } catch(e) {
            galleryContent.innerHTML = '<p class="text-red-400 text-center">Ocorreu um erro ao carregar as histórias.</p>';
        }
    }
    
    function closeGallery() {
        audio.playChoice();
        document.getElementById('galleryScreen').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
    }

    function restartGame() {
        audio.playChoice();
        selectedValues = [];
        document.getElementById('finalScreen').classList.add('hidden');
        const startScreen = document.getElementById('startScreen');
        startScreen.classList.remove('hidden');
        startScreen.style.animation = 'none'; void startScreen.offsetWidth; startScreen.style.animation = null; 
        document.getElementById('playerNameInput').value = '';
        setupStartScreen();
        checkStartButton();
        document.body.className = `bg-gray-900 text-white min-h-screen flex items-center justify-center p-4 bg-start`;
    }

    window.onload = () => {
        setupStartScreen();
        document.getElementById('galleryBtn').onclick = openGallery;
        document.body.addEventListener('click', () => audio.start(), { once: true });
    };

    </script>
</body>
</html>